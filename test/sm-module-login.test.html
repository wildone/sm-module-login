<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>sm-module-login</title>
    <script src="../../webcomponentsjs/webcomponents.min.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../test-fixture/test-fixture-mocha.js"></script>
    <link rel="import" href="../../test-fixture/test-fixture.html">
    <script>

    </script>
    <!-- Import the element to test -->
    <link rel="import" href="../sm-module-login.html">
    <script src="./sm-module-login.fixtures.js"></script>
  </head>
  <body>
    <test-fixture id="default">
      <template>
        <sm-module-login></sm-module-login>
      </template>
    </test-fixture>
    <script>
      describe('<sm-module-login>', function() {

        var component,
            componentFixtures,
            CODES = {
              401: 'Wrong username or pasword',
              500: 'Something has gone wrong on our servers'
            };

        componentFixtures = window.fixtures;

        beforeEach(function() {
          window.Simpla = {
            login: sinon.stub().returns(Promise.resolve()),
            observe: sinon.stub()
          };

          component = fixture('default');
        });

        it('is okay', function() {
          expect(component).to.be.ok;
        });

        it('should observe Simplas authentication.authenticated property', function() {
          expect(Simpla.observe.calledWith('authentication.authenticated')).to.be.true;
        });

        it('should pass a callback to observe that binds _authenticated', function() {
          let callback = Simpla.observe.lastCall.args[1];

          expect(callback).to.be.a.function;
          component._authenticated = false;

          callback(true);
          expect(component._authenticated).to.be.true;
        });

        it('calls _triggerErrorOpen when error property added', function(){
          sinon.stub(component, '_triggerErrorOpen');
          component._errorCode = 123;

          component.error = false;
          component.error = true;

          expect(component._triggerErrorOpen.called).to.be.true;
        });

        it('calls _triggerErrorClose when error property removed', function(){
          sinon.stub(component, '_triggerErrorClose');
          component._errorCode = 123;

          component.error = true;
          component.error = false;

          expect(component._triggerErrorClose.called).to.be.true;
        });

        it('sets error code when error recieved', function() {
          var code = 401,
              rejection = Promise.reject({ code: code });

          Simpla.login.returns(rejection);
          expect(component._errorCode).to.not.equal(code);

          return component.login().then(function() {
            expect(component._errorCode).to.equal(code);
          });
        });

        it('is busy while logging in is busy', function() {
          // Setup a promise which can be resolved at a later time
          var forceResolve,
              promise = new Promise(function(resolve) { forceResolve = resolve }),
              loggingIn;

          Simpla.login.returns(promise);

          // Should initially not be busy
          expect(component.busy).to.not.be.true;

          // When login starts, should be busy
          loggingIn = component.login();
          expect(component.busy).to.be.true;

          // After resolution, shouldn't be busy
          forceResolve();
          return loggingIn.then(function() {
            expect(component.busy).to.not.be.true;
          });
        });

        it('should use current email and password to login with', function() {
          component.email = 'email';
          component.password = 'password';

          component.login();
          expect(Simpla.login.lastCall.args[0]).to.deep.equal({
            email: 'email',
            password: 'password'
          });
        });

        it('should show busy state on submit button', function() {
          component.busy = true;
          expect(component.$.submit.hasAttribute('busy')).to.be.true;
        });

        it('should clear any existing error on authenticated', function() {
          component.error = true;
          component._authenticated = true;

          expect(component.error).to.be.false;
        });

        it('should clear any existing error when busy', function() {
          component.error = true;
          component.busy = true;

          expect(component.error).to.be.false;
        });

        it('should set the right error message on error', function(done) {
          Simpla.login.returns(Promise.reject({ code: 500 }));
          component.login();

          // Wait for animation to finish
          setTimeout(function() {
            expect(component.$.error.textContent).to.equal(CODES[500]);
            done();
          }, 500);
        });

        it('should call login() on submit click', function() {
          sinon.spy(component, 'login');
          component.$.submit.click();

          expect(component.login.called).to.be.true;
        });

        describe('show / hide #error depending on error property', function() {
          var isHidden = function(el) {
            return window.getComputedStyle(el).display === 'none';
          };

          it('should hide on error = false', function(done) {
            component.error = false;

            setTimeout(function() {
              expect(isHidden(component.$.error)).to.be.true;
              done();
            }, 500);
          });

          it('should show on error = true', function(done) {
            component.error = true;

            setTimeout(function() {
              expect(isHidden(component.$.error)).to.be.false;
              done();
            }, 500);
          });
        });
      });
    </script>
  </body>
</html>
