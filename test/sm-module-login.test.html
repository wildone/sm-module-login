<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>sm-module-login</title>
    <script src="../../webcomponentsjs/webcomponents.min.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../test-fixture/test-fixture-mocha.js"></script>
    <link rel="import" href="../../test-fixture/test-fixture.html">

    <!-- Import the element to test -->
    <link rel="import" href="../sm-module-login.html">
    <script src="./sm-module-login.fixtures.js"></script>
  </head>
  <body>
    <test-fixture id="default">
      <template>
        <sm-module-login></sm-module-login>
      </template>
    </test-fixture>
    <script>
      describe('<sm-module-login>', function() {

        var component,
            componentFixtures,
            CODES = {
              401: 'Wrong username or pasword',
              500: 'Something has gone wrong on our servers'
            };

        componentFixtures = window.fixtures;

        beforeEach(function() {
          component = fixture('default');
        });

        it('is okay', function() {
          expect(component).to.be.ok;
        });

        it('calls _triggerErrorOpen when error property added', function(){
          sinon.stub(component, '_triggerErrorOpen');
          component._errorCode = 123;

          component.error = false;
          component.error = true;

          expect(component._triggerErrorOpen.called).to.be.true;
        });

        it('calls _triggerErrorClose when error property removed', function(){
          sinon.stub(component, '_triggerErrorClose');
          component._errorCode = 123;

          component.error = true;
          component.error = false;

          expect(component._triggerErrorClose.called).to.be.true;
        });

        it('sets error message when error recieved', function() {
          expect(component._errorMessage).to.not.be.okay;
          component.$.auth.fire('error', {
            code: 400
          });

          expect(component._errorMessage).to.be.okay;
        });

        it('is busy when auth is busy', function() {
          expect(component.busy).to.not.be.true;
          component.$.auth.busy = true;
          expect(component.busy).to.be.true;
        });

        it('should show busy state on submit button', function() {
          component.busy = true;
          expect(component.$.submit.hasAttribute('busy')).to.be.true;
        });

        it('should clear any existing error on authenticated', function() {
          component.error = true;
          component.$.auth.authenticated = true;

          expect(component.error).to.be.false;
        });

        it('should clear any existing error when busy', function() {
          component.error = true;
          component.busy = true;

          expect(component.error).to.be.false;
        });

        it('should set the right error message on error', function(done) {
          component.$.auth.fire('error', {
            code: 500
          });

          // Wait for animation to finish
          setTimeout(function() {
            expect(component.$.error.textContent).to.equal(CODES[500]);
            done();
          }, 500);
        });

        it('should call login() on submit click', function() {
          sinon.stub(component, 'login');
          component.$.submit.click();

          expect(component.login.called).to.be.true;
        });

        it('should bind input values to auth email / password', function() {
          component.email = 'foobar';
          component.password = 'secret';

          expect(component.$.auth.email).to.equal(component.email);
          expect(component.$.auth.password).to.equal(component.password);
        });

        describe('show / hide #error depending on error property', function() {
          var isHidden = function(el) {
            return window.getComputedStyle(el).display === 'none';
          };

          it('should hide on error = false', function(done) {
            component.error = false;

            setTimeout(function() {
              expect(isHidden(component.$.error)).to.be.true;
              done();
            }, 500);
          });

          it('should show on error = true', function(done) {
            component.error = true;

            setTimeout(function() {
              expect(isHidden(component.$.error)).to.be.false;
              done();
            }, 500);
          });
        });
      });
    </script>
  </body>
</html>
