<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../sm-ui-core/sm-ui-core.html">
<link rel="import" href="../sm-ui-modal/sm-ui-modal.html">
<link rel="import" href="../sm-ui-button/sm-ui-button.html">

<dom-module id="sm-module-login">
  <template>
    <style include="sm-css-shady"></style>
    <style include="sm-css"></style>
    <style>/**
 * Config
 */
:root {

  --modal-width: 350px;

}

:host {
  @apply(--typography);
  text-align: center;
  position: relative;
  z-index: var(--on-top);
}

.login__form__input {
  display: inline-block;
  text-align: center;
  width: 85%;
  font-size: 18px;
  margin: 16px auto;
  padding: 8px 0;
  border-radius: var(--border-radius);
  overflow: auto;
  color: var(--text-color);
}

.login__form__input:first-child {
  margin-top: 0;
}

.login__form__input:focus {
  border-bottom-color: var(--blue);
  width: 85%;
}

.login__form__submit {
  dispaly: inline-block;
  background: var(--blue);
  font-weight: 600;
  color: white;
  border-radius: var(--border-radius);
  padding: 0 35px;
  margin: 21px auto 0;
  -webkit-transition: color 80ms ease;
  transition: color 80ms ease;
}

.login__form__submit[busy] {
  color: var(--med-white);
}

.login__form__submit--target {
  display: none;
}

.login__error {
  -webkit-box-align: center;
  -webkit-align-items: center;
      -ms-flex-align: center;
              -ms-grid-row-align: center;
          align-items: center;
  -webkit-box-pack: center;
  -webkit-justify-content: center;
      -ms-flex-pack: center;
          justify-content: center;
  text-align: center;
  margin: 0 auto;
  max-width: 220px;
  font-size: 15px;
  color: var(--red);
  opacity: 0;
  height: 0;
  overflow: visible;
  display: none;
}

.login__error[visible]{
  display: -webkit-box;
  display: -webkit-flex;
  display: -ms-flexbox;
  display: flex;
}
</style>

    <sm-ui-modal class="login" id="modal" title="Login" active="[[active]]">

      <form on-submit="login" class="login__form" id="form">
        <input id="email" class="login__form__input" value="{{email::input}}" type="text" placeholder="Enter your email">
        <input id="password" class="login__form__input" value="{{password::input}}" type="password" placeholder="Enter your password">
        <div id="error" class="login__error">[[errorMessage]]</div>
        <button is="sm-ui-button" type="submit" on-tap="login" id="submit" class="login__form__submit" busy="[[busy]]">let&apos;s go</button>

        <!-- Dummy hidden submit button so that pressing return triggers a form submit -->
        <input type="submit" class="login__form__submit--target">
      </form>
    </sm-ui-modal>
  </template>
  <script>(function () {
  'use strict';

  var babelHelpers = {};

  babelHelpers.classCallCheck = function (instance, Constructor) {
    if (!(instance instanceof Constructor)) {
      throw new TypeError("Cannot call a class as a function");
    }
  };

  babelHelpers.createClass = function () {
    function defineProperties(target, props) {
      for (var i = 0; i < props.length; i++) {
        var descriptor = props[i];
        descriptor.enumerable = descriptor.enumerable || false;
        descriptor.configurable = true;
        if ("value" in descriptor) descriptor.writable = true;
        Object.defineProperty(target, descriptor.key, descriptor);
      }
    }

    return function (Constructor, protoProps, staticProps) {
      if (protoProps) defineProperties(Constructor.prototype, protoProps);
      if (staticProps) defineProperties(Constructor, staticProps);
      return Constructor;
    };
  }();

  babelHelpers.slicedToArray = function () {
    function sliceIterator(arr, i) {
      var _arr = [];
      var _n = true;
      var _d = false;
      var _e = undefined;

      try {
        for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) {
          _arr.push(_s.value);

          if (i && _arr.length === i) break;
        }
      } catch (err) {
        _d = true;
        _e = err;
      } finally {
        try {
          if (!_n && _i["return"]) _i["return"]();
        } finally {
          if (_d) throw _e;
        }
      }

      return _arr;
    }

    return function (arr, i) {
      if (Array.isArray(arr)) {
        return arr;
      } else if (Symbol.iterator in Object(arr)) {
        return sliceIterator(arr, i);
      } else {
        throw new TypeError("Invalid attempt to destructure non-iterable instance");
      }
    };
  }();

  babelHelpers;

  var easings = simpla._constants.easings;
  var WOBBLE = '12px';
  var CODES = {
    401: 'Wrong username or pasword',
    500: 'Something has gone wrong on our servers'
  };
  var showError = {
    observers: ['_triggerError(error)'],

    _triggerError: function _triggerError(error) {
      if (error) {
        this._triggerErrorOpen();
      } else {
        this._triggerErrorClose();
      }
    },


    get _errorAnimations() {
      return {
        modal: {
          target: this.$.modal.getModal(),
          frames: [{ transform: 'translateX(0)' }, { transform: 'translateX(-' + WOBBLE + ')' }, { transform: 'translateX(0)' }, { transform: 'translateX(' + WOBBLE + ')' }, { transform: 'translateX(0)' }],
          opts: {
            easing: 'linear',
            duration: 145,
            iterations: 2
          }
        },
        error: {
          target: this.$.error,
          frames: [{ opacity: 0, height: 0 }, { opacity: 1, height: '55px' }],
          opts: {
            easing: easings.easeOutCubic,
            fill: 'both',
            duration: 140,
            delay: 80
          }
        }
      };
    },

    _triggerErrorOpen: function _triggerErrorOpen() {
      var _this = this;

      var modal = this._errorAnimations.modal,
          error = this._errorAnimations.error,
          modalAnimation = void 0;

      modalAnimation = modal.target.animate(modal.frames, modal.opts);

      modalAnimation.onfinish = function () {
        _this.errorMessage = CODES[_this._errorCode || 500];
        _this.toggleAttribute('visible', true, _this.$.error);
        error.target.animate(error.frames, error.opts);
      };
    },
    _triggerErrorClose: function _triggerErrorClose() {
      var _this2 = this;

      var _errorAnimations$erro = this._errorAnimations.error;
      var errorOutput = _errorAnimations$erro.target;
      var frames = _errorAnimations$erro.frames;
      var opts = _errorAnimations$erro.opts;
      var animation = void 0;

      animation = errorOutput.animate(frames.reverse(), opts);
      animation.onfinish = function () {
        _this2.toggleAttribute('visible', false, errorOutput);
        _this2.errorMessage = '';
      };
    }
  };

  var TOKEN_ISSUER = 'https://simpla.auth0.com/';
  var TOKEN_KEY = 'sm-token';
  function tokenIsValid(token) {
    var now = new Date().getTime() / 1000;
    var payload = void 0;

    if (!token) {
      return false;
    }

    try {
      var _token$split = token.split('.');

      var _token$split2 = babelHelpers.slicedToArray(_token$split, 2);

      var payloadString = _token$split2[1];

      payload = JSON.parse(atob(payloadString));
    } catch (e) {
      console.warn('Invalid token', e.message);
      return false;
    }

    // Check if payload has expired
    if (payload.exp && now > payload.exp) {
      return false;
    }

    // Check to see if issuer
    if (!payload.iss || payload.iss !== TOKEN_ISSUER) {
      return false;
    }

    return true;
  }

  var persistToken = {
    properties: {
      token: {
        type: String,
        observer: '_setTokenInStorage'
      }
    },

    ready: function ready() {
      var _this = this;

      var tokenInStorage = void 0;

      Simpla.observe('token', function (token) {
        return _this.token = token;
      });

      tokenInStorage = window.localStorage.getItem(TOKEN_KEY);

      if (tokenIsValid(tokenInStorage)) {
        // WARNING: This is private and should be removed in future
        Simpla._store.dispatch({
          type: 'login-successful',
          response: tokenInStorage
        });
      } else {
        window.localStorage.removeItem(TOKEN_KEY);
      }
    },
    _setTokenInStorage: function _setTokenInStorage(token) {
      window.localStorage.setItem(TOKEN_KEY, token);
    }
  };

  var SmModuleLogin = function () {
    function SmModuleLogin() {
      babelHelpers.classCallCheck(this, SmModuleLogin);
    }

    babelHelpers.createClass(SmModuleLogin, [{
      key: 'beforeRegister',
      value: function beforeRegister() {
        this.is = 'sm-module-login';

        this.properties = {
          error: Boolean,
          busy: {
            type: Boolean,
            observer: '_busyChanged'
          },
          email: String,
          password: String,
          active: {
            type: Boolean,
            computed: '_computeActive(_editing, _authenticated)'
          },
          _errorCode: Number,
          _authenticated: {
            type: Boolean,
            observer: '_authenticationChanged',
            value: Simpla.getState().authenticated
          },
          _editing: {
            type: Boolean,
            value: Simpla.getState().editing
          }
        };
      }
    }, {
      key: 'created',
      value: function created() {
        var _this = this;

        Simpla.observe('authenticated', function (authenticated) {
          _this._authenticated = authenticated;
        });

        Simpla.observe('editing', function (editing) {
          _this._editing = editing;
        });
      }
    }, {
      key: 'detached',
      value: function detached() {
        // Should reset all values so they're not persisted
        this.email = '';
        this.password = '';
      }
    }, {
      key: 'login',
      value: function login(event) {
        var _this2 = this;

        if (event) {
          event.preventDefault();
        }

        this.busy = true;
        return Simpla.login({ email: this.email, password: this.password }).catch(function (error) {
          return _this2._handleError(error);
        }).then(function () {
          return _this2.busy = false;
        });
      }
    }, {
      key: '_handleError',
      value: function _handleError(error) {
        this.error = true;
        this._errorCode = error.code;
      }
    }, {
      key: '_authenticationChanged',
      value: function _authenticationChanged(authenticated) {
        if (authenticated) {
          this.error = false;
        }
      }
    }, {
      key: '_busyChanged',
      value: function _busyChanged(busy) {
        if (busy) {
          this.error = false;
        }
      }
    }, {
      key: '_computeActive',
      value: function _computeActive(_editing, _authenticated) {
        return _editing && !_authenticated;
      }
    }, {
      key: 'behaviors',
      get: function get() {
        return [showError, persistToken];
      }
    }]);
    return SmModuleLogin;
  }();

  // Register with Polymer


  Polymer(SmModuleLogin);

  // Setup and
  var singleton = document.createElement('sm-module-login');
  var _inject = void 0;
  _inject = function inject() {
    if (document.body) {
      document.body.appendChild(singleton);
      document.removeEventListener('readystatechange', _inject);
    }
  };

  document.addEventListener('readystatechange', _inject);

}());</script>
</dom-module>
